---
title: "Null Sim"
author: "Nikos Ignatiadis"
date: "5/19/2015"
output: html_document
---

```{r}
library("ggplot2")
library("grid")
library("dplyr")
library("cowplot")
```

Start by loading in new files..So we can get a sense of what we want to do and plot:


```{r}
res_df <- readRDS("ddhw2_null_simulation_benchmark.Rds")
res_df <- filter(res_df, fdr_method != "qvalue")
methods <- unique(res_df$fdr_method)
res_df$fdr_method <- as.factor(res_df$fdr_method)

methods_pretty <- c("BH", "Clfdr", "Greedy Ind. Filtering", "IHW", "IHW naive", "FDRreg", "LSL GBH", "SBH", "TST GBH")
colors <- scales::hue_pal(h = c(0, 360) + 15, c = 100, l = 65, h.start = 0,direction = 1)(10)

conservative_methods <- c("BH", "Clfdr", "IHW", "FDRreg", "LSL GBH")
conservative_idx <- match(conservative_methods, methods_pretty)

anticonservative_methods <- c("Greedy Ind. Filtering", "IHW naive", "SBH", "TST GBH")
anticonservative_idx     <- match(anticonservative_methods, methods_pretty)

levels(res_df$fdr_method ) <- methods_pretty
```

Code for panel a)
```{r}
panel_a_df <- filter(res_df, fdr_method %in% anticonservative_methods) %>%
              filter(! fdr_method %in% "IHW naive")
panel_a_tmp_df <- readRDS("null_simulation_benchmark_grb3000.Rds")
panel_a_tmp_df <- filter(panel_a_tmp_df, fdr_method=="DDHW lp unregularized") %>% 
                  mutate(fdr_method="IHW naive") %>%
                  mutate(fdr_method=factor(fdr_method, levels=methods_pretty))
panel_a_df <- rbind(panel_a_df, panel_a_tmp_df)

last_vals <- group_by(panel_a_df, fdr_method) %>% summarize(last_vals = max(FDR))
last_vals$last_vals <- last_vals$last_vals + c(0, 0,0.05, -0.03)
gg <- ggplot(panel_a_df, aes(x=alpha, y=FDR, col=fdr_method)) +
                         geom_abline(linetype="dashed") + 
                         geom_line() +
                         xlab(expression(bold(paste("Nominal ",alpha)))) + 
                         scale_x_continuous(limits= c(0.01,0.1), breaks=seq(0.01,0.09,length=5)) +
                         ylim(0,0.9) +
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[anticonservative_idx])


for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[anticonservative_idx[i]])),
                               xmin=0.102, xmax=0.102,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
panel_a <- ggdraw(gt)
panel_a

```
Code for panel B)
```{r}
panel_b_df <- filter(res_df, fdr_method %in% conservative_methods)

last_vals <- group_by(panel_b_df, fdr_method) %>% summarize(last_vals = max(FDR))
last_vals$last_vals <- last_vals$last_vals + c(0.005,0.005,-0.005, 0 ,-0.005 )

gg <- ggplot(panel_b_df, aes(x=alpha, y=FDR, col=fdr_method)) +
                         geom_abline(linetype="dashed") + 
                         geom_line() +
                         xlab(expression(bold(paste("Nominal ",alpha)))) + 
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[conservative_idx])

for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[conservative_idx[i]])),
                               xmin=0.102, xmax=0.102,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
panel_b <- ggdraw(gt)
panel_b
```

Code to put panels a) and b) together

```{r}
#panel_a <- panel_a + theme(plot.margin=unit(c(1.4,.2,.2,.2),"cm"))
#panel_b <- panel_b + theme(plot.margin=unit(c(1.4,.2,.2,.2),"cm"))
panel_ab <- plot_grid(panel_a, panel_b, labels=c("a)","b)"), vjust=4.5) 
          

panel_ab <- ggdraw(panel_ab) +
          geom_rect(aes(xmin=0,xmax=1,ymin=0,ymax=0.95),
                            color="black",alpha=0.0) +
          draw_label("Nulls only", x = 1, y = 1,
            vjust = 1, hjust = 1, size = 15, fontface = 'bold') +
          theme(plot.margin=unit(c(.2,.2,.2,.2),"cm"))

panel_ab

plot_grid(panel_a, panel_b) 
#ggsave("null_all.pdf",width=11,height=5.5)
```

Start with data for panels c), d)
```{r}
res_df <- readRDS("ddhw2_du_ttest_informative_simulation_benchmark.Rds")
res_df <- filter(res_df, fdr_method != "qvalue")
methods <- unique(res_df$fdr_method)
res_df$fdr_method <- as.factor(res_df$fdr_method)
levels(res_df$fdr_method ) <- methods_pretty
```

Panel c) plot
```{r}
panel_c_df <- filter(res_df, fdr_method %in% conservative_methods, alpha==0.1)

last_vals <- group_by(panel_c_df, fdr_method) %>% summarize(last_vals = FDR[which.max(eff_size)])
last_vals$last_vals <- last_vals$last_vals + c(0,0.005,-0.005, 0 ,-0.01 )

gg <- ggplot(panel_c_df, aes(x=eff_size, y=FDR, col=fdr_method)) +
                         geom_hline(yintercept=0.1, linetype="dashed") + 
                         geom_line() +
                         xlab("Effect size") + 
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[conservative_idx])

for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[conservative_idx[i]])),
                               xmin=2.52, xmax=2.52,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
panel_c <- ggdraw(gt)
panel_c
```

Panel d) plot

```{r}
last_vals <- group_by(panel_c_df, fdr_method) %>% summarize(last_vals = power[which.max(eff_size)])
last_vals$last_vals <- last_vals$last_vals + c(0,-0.015,-0.035, 0.035 ,+0.005 )

gg <- ggplot(panel_c_df, aes(x=eff_size, y=power, col=fdr_method)) +
                         geom_line() +
                         xlab("Effect size") + 
                         ylab("Power")+
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[conservative_idx])

for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[conservative_idx[i]])),
                               xmin=2.52, xmax=2.52,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
panel_d <- ggdraw(gt)
panel_d
```

Put panels c), d) together:

```{r}
panel_cd <- plot_grid(panel_c, panel_d, labels=c("c)","d)"), vjust=4.5) 

#plot_grid(panel_c, panel_d) 
#ggsave("t_test_full.pdf",width=11,height=5.5)
panel_cd <- ggdraw(panel_cd) +
          geom_rect(aes(xmin=0,xmax=1,ymin=0,ymax=0.95),
                            color="black",alpha=0.0) +
          draw_label("effect size", x = 1, y = 1,
            vjust = 1, hjust = 1, size = 15, fontface = 'bold') +
          theme(plot.margin=unit(c(.2,.2,.2,.2),"cm"))

panel_cd
```

OK time for panels e), f)

```{r}
res_df <- readRDS("ddhw2_wasserman_normal_simulation_benchmark_unbiased.Rds")
res_df_tmp <- readRDS("ddhw2_wasserman_normal_simulation_benchmark_unbiased_scott.Rds")
res_df <- rbind(res_df,res_df_tmp)
methods <- unique(res_df$fdr_method)
res_df$fdr_method <- as.factor(res_df$fdr_method)
levels(res_df$fdr_method ) <- methods_pretty[conservative_idx][c(1,2,3,5,4)]
res_df$fdr_method <- factor(as.character(res_df$fdr_method), levels=methods_pretty)
res_df$xi_max <- sapply(strsplit(res_df$sim_pars,"xi_max:"), function(x) as.numeric(x[2]))
ref_df <- group_by(res_df, xi_max) %>% mutate(normalized = log2(power/max(power*(fdr_method=="BH"))))

```

panel e)
```{r}
panel_e_df <- filter(res_df, fdr_method %in% conservative_methods, alpha==0.1)

last_vals <- group_by(panel_e_df, fdr_method) %>% summarize(last_vals = FDR[which.max(xi_max)])
last_vals$last_vals <- last_vals$last_vals + c(0.0009,0,-0.0009, 0 ,0 )

gg <- ggplot(panel_e_df, aes(x=xi_max, y=FDR, col=fdr_method)) +
                         geom_hline(yintercept=0.1, linetype="dashed") + 
                         geom_line() +
                         xlab(expression(bold(xi[max])))+
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[conservative_idx])
gg
for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[conservative_idx[i]])),
                               xmin=6.02, xmax=6.02,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
panel_e <- ggdraw(gt)
panel_e
```

Panel f)

```{r}
panel_f_df <- group_by(panel_e_df, xi_max) %>% mutate(normalized = log2(power/max(power*(fdr_method=="BH"))))

last_vals <- group_by(panel_f_df, fdr_method) %>% summarize(last_vals = normalized[which.max(xi_max)])
last_vals$last_vals <- last_vals$last_vals + c(0, 0, 0, -0.002 ,+0.008 )

gg <- ggplot(panel_f_df, aes(x=xi_max, y=normalized, col=fdr_method)) +
                         geom_line() +
                         ylab(expression(bold(log[2](Power/Power[BH]))))+
                         xlab(expression(bold(xi[max])))+
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[conservative_idx])

for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[conservative_idx[i]])),
                               xmin=6.02, xmax=6.02,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
panel_f <- ggdraw(gt)
panel_f
```

panel ef
```{r}
panel_ef <- plot_grid(panel_e, panel_f, labels=c("e)","f)"), vjust=4.5) 

#plot_grid(panel_c, panel_d) 
#ggsave("t_test_full.pdf",width=11,height=5.5)
panel_ef <- ggdraw(panel_ef) +
          geom_rect(aes(xmin=0,xmax=1,ymin=0,ymax=0.95),
                            color="black",alpha=0.0) +
          draw_label("size investing", x = 1, y = 1,
            vjust = 1, hjust = 1, size = 15, fontface = 'bold') +
          theme(plot.margin=unit(c(.2,.2,.2,.2),"cm"))

panel_ef
```
combine everything!

```{r}
plot_grid(panel_ab,panel_cd, panel_ef, nrow=3)
ggsave("main_simulations.pdf", width=12, height=16)
```






OK now we move on to the supplement:

```{r}
res_df <- readRDS("ddhw2_du_ttest_informative_simulation_benchmark.Rds")
res_df <- filter(res_df, fdr_method != "qvalue")
methods <- unique(res_df$fdr_method)
res_df$fdr_method <- as.factor(res_df$fdr_method)
levels(res_df$fdr_method ) <- methods_pretty
```

Panel a)  supplement plot
```{r}
sup_panel_a_df <- filter(res_df, fdr_method %in% anticonservative_methods, alpha==0.1)

last_vals <- group_by(sup_panel_a_df, fdr_method) %>% summarize(last_vals = FDR[which.max(eff_size)])
last_vals$last_vals <- last_vals$last_vals + c(-0.013,0,0, +0.013 )

gg <- ggplot(sup_panel_a_df, aes(x=eff_size, y=FDR, col=fdr_method)) +
                         geom_hline(yintercept=0.1, linetype="dashed") + 
                         geom_line() +
                         xlab("Effect size") + 
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[anticonservative_idx])

for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[anticonservative_idx[i]])),
                               xmin=2.52, xmax=2.52,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
sup_panel_a <- ggdraw(gt)
sup_panel_a
```

supplement panel b)

```{r}
last_vals <- group_by(sup_panel_a_df, fdr_method) %>% summarize(last_vals = power[which.max(eff_size)])
last_vals$last_vals <- last_vals$last_vals + c(+0.015,+0.03,-0.03, -0.015 )

gg <- ggplot(sup_panel_a_df, aes(x=eff_size, y=power, col=fdr_method)) +
                         geom_line() +
                         xlab("Effect size") + 
                         ylab("Power")+
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[anticonservative_idx])

for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[anticonservative_idx[i]])),
                               xmin=2.52, xmax=2.52,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
sup_panel_b <- ggdraw(gt)
sup_panel_b
```

Put panels a), b) together:

```{r}
sup_panel_ab<- plot_grid(sup_panel_a, sup_panel_b, labels=c("a)","b)"), vjust=4.5) 

#plot_grid(panel_c, panel_d) 
#ggsave("t_test_full.pdf",width=11,height=5.5)
sup_panel_ab <- ggdraw(sup_panel_ab) +
          geom_rect(aes(xmin=0,xmax=1,ymin=0,ymax=0.95),
                            color="black",alpha=0.0) +
          draw_label("effect size", x = 1, y = 1,
            vjust = 1, hjust = 1, size = 15, fontface = 'bold') +
          theme(plot.margin=unit(c(.2,.2,.2,.2),"cm"))

sup_panel_ab
```


```{r}
res_df <- readRDS("wasserman_normal_simulation_benchmark_grb.Rds")
methods <- unique(res_df$fdr_method)
res_df <- filter(res_df, fdr_method %in% c("BH","DDHF","DDHW lp unregularized","SBH 20 bins", "TST GBH 20 bins"))
res_df$fdr_method <- as.factor(res_df$fdr_method)
levels(res_df$fdr_method ) <- methods_pretty[c(1,3,5,8,9)]
res_df$fdr_method <- factor(as.character(res_df$fdr_method), levels=methods_pretty)
res_df$xi_max <- sapply(strsplit(res_df$sim_pars,"xi_max:"), function(x) as.numeric(x[2]))
res_df <- group_by(res_df, xi_max) %>% mutate(normalized = log2(power/max(power*(fdr_method=="BH")))) 

```

panel c) sup
```{r}
sup_panel_c_df <- filter(res_df, fdr_method %in% anticonservative_methods, alpha==0.1)

last_vals <- group_by(sup_panel_c_df, fdr_method) %>% summarize(last_vals = FDR[which.max(xi_max)])
last_vals$last_vals <- last_vals$last_vals + c(0.004,0, 0,-0.004)

gg <- ggplot(sup_panel_c_df, aes(x=xi_max, y=FDR, col=fdr_method)) +
                         geom_hline(yintercept=0.1, linetype="dashed") + 
                         geom_line() +
                         xlim(3,6)+
                         xlab(expression(bold(xi[max])))+
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[anticonservative_idx])
gg
for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[anticonservative_idx[i]])),
                               xmin=6.02, xmax=6.02,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
sup_panel_c <- ggdraw(gt)
sup_panel_c
```

Panel f)

```{r}

last_vals <- group_by(sup_panel_c_df, fdr_method) %>% summarize(last_vals = normalized[which.max(xi_max)])
last_vals$last_vals <- last_vals$last_vals + c(0.01,0.015, 0, -0.01)

gg <- ggplot(sup_panel_c_df, aes(x=xi_max, y=normalized, col=fdr_method)) +
                         geom_line() +
                         ylab(expression(bold(log[2](Power/Power[BH]))))+
                         xlab(expression(bold(xi[max])))+
                         xlim(3,6)+
                         ylim(-0.1,+0.2)+
                         theme(legend.position="none") +
                         theme(plot.margin = unit(c(3, 7.5, .2, .2), "lines"))+
                         scale_color_manual(values=colors[anticonservative_idx])

for (i in 1:nrow(last_vals)) {
  gg <- gg + annotation_custom(grob=textGrob(last_vals$fdr_method[i], hjust=0,
                                             gp=gpar(fontsize=13, 
                                                     col=colors[anticonservative_idx[i]])),
                               xmin=6.02, xmax=6.02,
                               ymin=last_vals$last_vals[i], ymax=last_vals$last_vals[i])
}
gg
gb <- ggplot_build(gg)
gt <- ggplot_gtable(gb)
 
gt$layout$clip[gt$layout$name=="panel"] <- "off"
 
sup_panel_d <- ggdraw(gt)
sup_panel_d
```

panel ef
```{r}
sup_panel_cd <- plot_grid(sup_panel_c, sup_panel_d, labels=c("c)","d)"), vjust=4.5) 

#plot_grid(panel_c, panel_d) 
#ggsave("t_test_full.pdf",width=11,height=5.5)
sup_panel_cd <- ggdraw(sup_panel_cd) +
          geom_rect(aes(xmin=0,xmax=1,ymin=0,ymax=0.95),
                            color="black",alpha=0.0) +
          draw_label("size investing", x = 1, y = 1,
            vjust = 1, hjust = 1, size = 15, fontface = 'bold') +
          theme(plot.margin=unit(c(.2,.2,.2,.2),"cm"))

sup_panel_cd
```
combine everything!

```{r}
plot_grid(sup_panel_ab,sup_panel_cd, nrow=2)
ggsave("suppl_simulations.pdf", width=12, height=12)
```